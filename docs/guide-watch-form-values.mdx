---
id: guide-watch-form-values
title: 监听表单值变化
---

:::info 示例源码

本章节的示例代码可以在 [sinoform-plugins-web-component-examples/src/plugins/detail-page-extends](https://gitee.com/sinoui/sinoform-plugins-web-component-examples/tree/master/src/plugins/detail-page-extends) 中找到。

:::

我们可以通过扩展详情页业务逻辑的方式添加`监听表单值变化`的方法。一般分成两步：

1. 创建扩展方法
2. 将扩展方法注册到表单中

## 创建扩展方法

下面的示例中，我们创建一个名为`helloExtends`的钩子方法，在这个方法中监听表单值的变化，然后控制台输出变化前后的值。

```ts title="src/plugins/detail-page-extends/helloExtends.ts"
import AppSetting from "@sinoform/app-setting";

AppSetting.hooks.detailPage.tap(
  "helloExtends", // 详情页拓展逻辑钩子的名称
  (detailPageContext) => {
    const { hooks, formData = {}, formState } = detailPageContext;
    const { formDesign: { id } = {} } = formData;

    // 根据表单设计id，判断拓展逻辑是否对该表单生效，如果不加这层判断，则默认拓展逻辑对所有表单都适用
    if (id === "612df55ac9327f1383eb4bbb") {
      // 监听表单值变化
      hooks.valueChange.tap(
        "helloExtends", // 拓展逻辑的事件名称，原则上与钩子的名称保持一致
        (prevValue, nextValue) => {
          // 控制台输出变化前后的值
          console.log(
            `表单值发生变化：${JSON.stringify(
              prevValue
            )}=======>${JSON.stringify(nextValue)}`
          );
        }
      );
    }
  }
);
```

拓展方法开发完成之后只需要在`src/index.ts`中引入该文件，即可完成该拓展方法的注册。

```typescript
import "./plugins/detail-page-extends/helloExtends";
```

## 表单设计 id 的获取方式

对于表单设计 id 的获取方式，我们可以从智能表单管理端打开需要绑定的表单，然后在 url 上截取，url 一般为`http://<网关ip:port>/intellisense-form-manager/:formDesignId?xxx=xxx`。如图：

![获取formDesignId](/img/get_formdesignId.png)

## 更多示例

以一个产品采购表单为例，我们监听产品的`单价`和`数量`，自动计算出产品总价。具体代码如下：

```ts title="src/plugins/detail-page-extends/watchFormValuesExtends.ts"
import AppSetting from "@sinoform/app-setting";

AppSetting.hooks.detailPage.tap(
  "watchFormValuesExtends",
  (detailPageContext) => {
    const { hooks, formData = {}, formState } = detailPageContext;
    const { formDesign: { id } = {} } = formData;

    if (id === "612df55ac9327f1383eb4bbb") {
      // 监听表单值变化
      hooks.valueChange.tap(
        "watchFormValuesExtends",
        (prevValue, nextValue) => {
          // 判断A产品的单价或数量有没有发生变化，如果有，设置A产品总价的值
          if (
            nextValue["price"] !== prevValue["price"] ||
            nextValue["count"] !== prevValue["count"]
          ) {
            formState.setFieldValue(
              "total",
              nextValue["price"] * nextValue["count"]
            );
          }
        }
      );
    }
  }
);
```
