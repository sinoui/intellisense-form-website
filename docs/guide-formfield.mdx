---
id: guide-formfield
title: 开发一个表单项
---

一个完整的表单项需要有三个组件来完成

- render。表单项渲染组件
- preview。表单项预览组件
- configPanel。表单项的属性配置面板组件，目前属性面板只支持以 react 组件的方式开发

:::info 示例源码

本章节得示例代码可以在[sinoform-plugins-web-component-examples/src/plugins/form-field-input](https://gitee.com/sinoui/sinoform-plugins-web-component-examples/tree/master/src/plugins/form-field-input)中找到。

:::

### 基本的代码结构

```ts
// 定义InputRenderer组件
class InputRenderer extends HTMLElement {
  connectedCallback() {
    this.innerHTML = this.render();
  }

  render() {
    // 生成dom模板字符串
    return `<input id="field-input-renderer" />`;
  }
}
```

### 获取传递给组件的 props 值

使用 get/set 的方式，在组件内部维护一个对应的私有变量来同步 props 中的属性值。获取 props 中的 value 值，并将其赋值给 input

```ts
set value(val: string) {
    this._value = val;
    this.input.val(val);
  }

get value() {
  return this._value;
}
```

如果组件外部触发 value 值变化之后还需要同步到组件内部，所以需要在组件内部添加属性监听，使用 web components 的`observedAttributes`和`attributeChangedCallback`回调函数。

```ts
// 静态方法，返回值就是需要监听的属性
static get observedAttributes() {
    return ['value'];
  }

// 属性值变化之后的回调函数
attributeChangedCallback(attr: string, _oldVal: any, newVal: any) {
  switch (attr) {
    case 'value':
      this.value = newVal;
      break;

    default:
      break;
  }
}
```

需要注意的是 props 属性的 set 方法初次触发的时机要比 connectedCallback 早，所以 connectedCallback 中执行 render 时候会导致 input 的值丢失。两种方式解决此问题

1. 直接在 render 方法中指定 input 的 value 值

```ts
render() {
  return `<input class="field-input-renderer" value='${this.value}'/>`;
}
```

2. innerHTML 之后为 input 手动赋值

```ts
connectedCallback() {
  this.innerHTML = this.render();
  this.input = $(".field-input-renderer", this);
  this.input.val(this.value);
}
```

至此，表单项的值在组件内部的回显处理完毕。

### 添加或销毁事件监听

组件内部添加 input 输入框 change 事件监听，在值变化之后需要调用 props 中传入的 onChange 事件将值提供给外层组件

```ts
connectedCallback() {
  this.innerHTML = this.render();
  this.input = $(".field-input-renderer", this);
  this.input.on('change', this.handleInputChange);
}

disConnectedCallback() {
  this.input.off('change', this.handleInputChange);
}

handleInputChange(e: any){
  this.onChange(e.target.value);
}
```

完整的示例代码

```ts
import $ from "jquery";
import "./index.css";

export default class InputRenderer extends HTMLElement {
  private _value: string = "";
  private input: JQuery<HTMLElement> | null = null;
  private _onChange: any;

  constructor() {
    super();

    this.handleInputChange = this.handleInputChange.bind(this);
  }

  connectedCallback() {
    this.innerHTML = this.render();
    this.input = $(".field-input-renderer", this);
    this.input.on("change", this.handleInputChange);
  }

  disConnectedCallback() {
    this.input?.off("change", this.handleInputChange);
  }

  static get observedAttributes() {
    return ["value"];
  }

  attributeChangedCallback(attr: string, _oldVal: any, newVal: any) {
    switch (attr) {
      case "value":
        this.value = newVal;
        break;

      default:
        break;
    }
  }

  set onChange(fn: any) {
    this._onChange = fn;
  }

  get onChange() {
    return this._onChange;
  }

  handleInputChange(e: any) {
    this.onChange(e.target.value);
  }

  set value(val: string) {
    this._value = val;
    this.input?.val(val);
  }

  get value() {
    return this._value;
  }

  render() {
    return `<input class="field-input-renderer" value='${this.value}'/>`;
  }
}
```

preview 组件是预览组件，不涉及业务逻辑交互，不需要事件监听处理，属于比较纯粹的 ui 组件。

## 在智能表单产品中调试插件

本小节以智能表单外网演示环境来说明如何在智能表单产品中调试插件。

打开[登录页](http://121.30.232.162:18880/sso/)，使用账号 `智能表单管理员`（密码是：`1qaz2wsx!`） 登录系统，然后选择表单设计器，进入智能表单管理页面。

打开表单`演示自定义表单项`，在表单设计界面可以在左侧的基础字段中看到新增的自定义表单项，拖动它到中间区域就可以完整自定义表单项的添加。

![设计界面](assets/custominput-in-design.png)

打开预览界面就可以实时测试自定义表单项的功能。

![预览界面](assets/custominput-in-preview.png)

进入产品示例系统，在`演示自定义表单项`的表单详情页中也可以测试自定义表单项。

![详情界面](assets/custominput-in-detail.png)
